<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AWD Controller</title>

    <!-- CSS Modules -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/modules/vars.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/modules/base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/modules/layout.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/modules/components.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/modules/terminal.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/modules/attack.css') }}">

    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <style>
        /* Agent çŠ¶æ€å‘¼å¸ç¯åŠ¨ç”» */
        @keyframes pulse {
            0% { opacity: 1; text-shadow: 0 0 5px #00d4ff; }
            50% { opacity: 0.6; text-shadow: 0 0 2px #00d4ff; }
            100% { opacity: 1; text-shadow: 0 0 5px #00d4ff; }
        }
        .agent-status-indicator.online {
            animation: pulse 2s infinite;
        }
        .agent-status-indicator.offline {
            opacity: 0.3;
        }
    </style>
</head>

<body>

    <div class="app-layout">
        <!-- Sidebar -->
        <div class="app-sidebar">
            <div class="sidebar-header">
                <div class="sidebar-brand-icon">ğŸ›¡ï¸</div>
                <div class="sidebar-brand">AWD Defender</div>
            </div>
            <div class="sidebar-nav">
                <div class="nav-item active" onclick="switchView('dashboard', this)">
                    <div class="nav-icon">ğŸ“Š</div>
                    <div class="nav-text">æ§åˆ¶å° (Dashboard)</div>
                </div>
                <div class="nav-item" onclick="switchView('attacks', this)">
                    <div class="nav-icon">âš”ï¸</div>
                    <div class="nav-text">æ”»å‡» (Attack)</div>
                </div>
                <div class="nav-item" onclick="switchView('alerts', this)">
                    <div class="nav-icon" style="color: #e74c3c;">ğŸš¨</div>
                    <div class="nav-text" style="color: #e74c3c; font-weight: bold;">å‘Šè­¦ (Alerts)</div>
                    <span id="nav-alert-badge"
                        style="display:none; background:#e74c3c; color:white; font-size:10px; padding:2px 6px; border-radius:10px; margin-left:auto;">0</span>
                </div>
                <div class="nav-item" onclick="switchView('monitor', this)">
                    <div class="nav-icon">ğŸ“Š</div>
                    <div class="nav-text">æ–‡ä»¶ç›‘æ§ (Monitor)</div>
                </div>
            </div>
            <!-- Bottom Actions -->
            <div
                style="padding: 10px; border-top: 1px solid var(--border-color); display:flex; flex-direction:column; gap:5px;">
                <div class="nav-item" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">
                    <div class="nav-icon">ğŸŒ“</div>
                    <div class="nav-text">åˆ‡æ¢ä¸»é¢˜</div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="app-main">

            <!-- View: Dashboard (Default) -->
            <div id="view-dashboard" class="view-section active">
                <div class="header">
                    <h1>AWD Controller</h1>
                    <div class="flex-row">
                        <button class="btn btn-primary" onclick="connectAll()">ğŸ”— å…¨éƒ¨è¿æ¥</button>
                        <button class="btn btn-secondary" onclick="disconnectAll()">â›“ï¸ å…¨éƒ¨æ–­å¼€</button>
                        <button class="btn btn-warning" onclick="batchExecutePrompt()">âš¡ æ‰¹é‡æ‰§è¡Œ</button>
                        <button class="btn btn-secondary" onclick="checkConnections()">ğŸ’“ æ£€æŸ¥è¿æ¥</button>
                    </div>
                </div>

                <div class="container">
                    <!-- Config & Targets Section (Original Content) -->
                    <div class="card">
                        <details open>
                            <summary>âš™ï¸ Configuration & Targets</summary>
                            <div class="card-content">
                                <!-- Preload, Scheduled Tasks, Rules, AOI, Target Form, Target List -->

                                <!-- Preload Config -->
                                <details style="margin-bottom: 20px;">
                                    <summary>âš™ï¸ Preload Tasks (Auto-run on Connect)</summary>
                                    <div class="card-content" style="padding-top: 10px;">
                                        <div class="flex-row" style="margin-bottom: 10px;">
                                            <input type="file" id="preload-file" style="width: 200px;">
                                            <input type="text" id="preload-path" placeholder="Remote Path"
                                                style="width: 200px;">
                                            <button class="btn btn-primary btn-sm" onclick="addPreloadFile()">Add
                                                File</button>
                                            <div style="width: 20px;"></div>
                                            <input type="text" id="preload-cmd" placeholder="Command"
                                                style="flex-grow: 1;">
                                            <button class="btn btn-primary btn-sm" onclick="addPreloadCmd()">Add
                                                Cmd</button>
                                        </div>

                                        <div
                                            style="max-height: 150px; overflow-y: auto; border: 1px solid var(--border-color); padding: 10px; border-radius: 4px;">
                                            {% for f in preload.files %}
                                            <div class="flex-row" style="margin-bottom: 5px; font-size: 12px;">
                                                <span>ğŸ“„ {{ f.filename }} &rarr; {{ f.remote_path }}</span>
                                                <span class="spacer"></span>
                                                <button class="btn btn-danger btn-sm"
                                                    onclick="removePreload('file', '{{ loop.index0 }}')">Ã—</button>
                                            </div>
                                            {% endfor %}
                                            {% for cmd in preload.commands %}
                                            <div class="flex-row" style="margin-bottom: 5px; font-size: 12px;">
                                                <span>ğŸ’» {{ cmd }}</span>
                                                <span class="spacer"></span>
                                                <button class="btn btn-danger btn-sm"
                                                    onclick="removePreload('cmd', '{{ loop.index0 }}')">Ã—</button>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </details>

                                <!-- å®šæ—¶ä»»åŠ¡ç®¡ç† -->
                                <details style="margin-bottom: 20px;">
                                    <summary>â° å®šæ—¶ä»»åŠ¡ (åœ¨æ‰€æœ‰å·²è¿æ¥é¶æœºä¸Šå®šæ—¶æ‰§è¡Œ)</summary>
                                    <div class="card-content" style="padding-top: 10px;">
                                        <div class="flex-row" style="margin-bottom: 10px;">
                                            <input type="text" id="task-name" placeholder="ä»»åŠ¡åç§°" style="width: 150px;">
                                            <input type="text" id="task-cmd" placeholder="å‘½ä»¤ (å¦‚: rm -f /tmp/*.php)"
                                                style="flex-grow: 1;">
                                            <input type="text" id="task-interval" placeholder="é—´éš”(ç§’)" value="300"
                                                style="width: 80px;">
                                            <button class="btn btn-primary btn-sm"
                                                onclick="addScheduledTask()">æ·»åŠ ä»»åŠ¡</button>
                                        </div>
                                        <div id="scheduled-tasks-list"
                                            style="max-height: 150px; overflow-y: auto; border: 1px solid var(--border-color); padding: 10px; border-radius: 4px; font-size: 12px; color: #999;">
                                            åŠ è½½ä¸­...
                                        </div>
                                    </div>
                                </details>

                                <!-- è‡ªå®šä¹‰ PHP æ£€æµ‹è§„åˆ™ -->
                                <details style="margin-bottom: 20px;">
                                    <summary>ğŸ›¡ï¸ è‡ªå®šä¹‰ PHP æ£€æµ‹è§„åˆ™ (è¡¥å……å†…ç½®æ‰«æçš„ grep æ­£åˆ™)</summary>
                                    <div class="card-content" style="padding-top: 10px;">
                                        <div class="flex-row" style="margin-bottom: 10px;">
                                            <input type="text" id="rule-name" placeholder="è§„åˆ™åç§°" style="width: 120px;">
                                            <input type="text" id="rule-pattern" placeholder="æ­£åˆ™è¡¨è¾¾å¼ (å¦‚: mysql_query\\()"
                                                style="flex-grow: 1;">
                                            <input type="text" id="rule-desc" placeholder="æè¿°(å¯é€‰)"
                                                style="width: 150px;">
                                            <button class="btn btn-primary btn-sm"
                                                onclick="addCustomRule()">æ·»åŠ è§„åˆ™</button>
                                        </div>
                                        <div id="custom-rules-list"
                                            style="max-height: 150px; overflow-y: auto; border: 1px solid var(--border-color); padding: 10px; border-radius: 4px; font-size: 12px; color: #999;">
                                            åŠ è½½ä¸­...
                                        </div>
                                    </div>
                                </details>

                                <!-- AOI/æ–‡ä»¶ç›‘æ§ å·¥å…·é…ç½® -->
                                <details style="margin-bottom: 20px;">
                                    <summary>ğŸ›¡ï¸ æœ¬æœºIP (å›è¿/ç›‘æ§)</summary>
                                    <div class="card-content" style="padding-top: 10px;">
                                        <div class="flex-row" style="margin-bottom: 10px; align-items:center;">
                                            <span style="font-size:12px; color:#999; white-space:nowrap;">æœ¬æœº IPï¼š</span>
                                            <input type="text" id="local-ip-input" placeholder="å¦‚: 10.4.51.119"
                                                value="{{ local_ip }}" style="width: 200px;">
                                            <button class="btn btn-primary btn-sm" onclick="saveLocalIp()">ä¿å­˜</button>
                                            <span id="local-ip-status" style="font-size:11px; margin-left:8px;"></span>
                                        </div>
                                        <div
                                            style="font-size:11px; color:#666; padding:6px 8px; background:var(--card-bg); border:1px solid var(--border-color); border-radius:4px;">
                                            <div>ğŸ“¦ <code>tapeworm.phar</code> â†’
                                                <code>php tapeworm.phar -d /var/www/html -s &lt;æœ¬æœºIP&gt;:8023</code>
                                            </div>
                                            <div>ğŸ“¦ <code>roundworm</code> â†’
                                                <code>./roundworm -d -s &lt;æœ¬æœºIP&gt; -w /var/www/html</code>
                                            </div>
                                            <div style="color:#f39c12; margin-top:4px;">âš ï¸ æœªé…ç½®æœ¬æœº IP æ—¶ä¸ä¼šè‡ªåŠ¨éƒ¨ç½²</div>
                                        </div>
                                    </div>
                                </details>

                        </details>

                        <!-- æŒç»­æŸ¥æ€ç®¡ç† (Persistent Killers) -->
                        <details style="margin-bottom: 20px;" open>
                            <summary>âš¡ æŒç»­æŸ¥æ€ä»»åŠ¡ (Active Persistent Killers)</summary>
                            <div class="card-content" style="padding-top: 10px;">
                                <div style="display:flex; justify-content:flex-end; margin-bottom:10px;">
                                    <button class="btn btn-sm btn-secondary" onclick="loadActiveKillers()">ğŸ”„
                                        åˆ·æ–°åˆ—è¡¨</button>
                                </div>
                                <div id="active-killers-list"
                                    style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color); padding: 0; border-radius: 4px;">
                                    <table style="width:100%; font-size:12px;">
                                        <thead>
                                            <tr>
                                                <th style="padding:8px;">Target</th>
                                                <th style="padding:8px;">File</th>
                                                <th style="padding:8px;">Status</th>
                                                <th style="padding:8px;">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody id="active-killers-tbody">
                                            <tr>
                                                <td colspan="4" class="empty-placeholder">
                                                    åŠ è½½ä¸­...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </details>

                        <!-- SSH å¯†é’¥ç®¡ç† -->
                        <details style="margin-bottom: 20px;">
                            <summary>ğŸ”‘ SSH å¯†é’¥ç®¡ç† (Key Management)</summary>
                            <div class="card-content" style="padding-top: 10px;">
                                <div class="flex-row" style="margin-bottom: 10px; align-items: flex-end; gap: 10px;">
                                    <div>
                                        <div style="font-size: 12px; color: #999; margin-bottom: 2px;">ğŸ“„ é€‰æ‹©å¤šä¸ªæ–‡ä»¶
                                            (Shift/Ctrl)</div>
                                        <input type="file" id="key-upload-input" multiple style="width: 200px;">
                                    </div>
                                    <div>
                                        <div style="font-size: 12px; color: #999; margin-bottom: 2px;">ğŸ“‚ æˆ–é€‰æ‹©æ–‡ä»¶å¤¹
                                            (Folder)</div>
                                        <input type="file" id="key-upload-folder" webkitdirectory directory multiple
                                            style="width: 200px;">
                                    </div>
                                    <button class="btn btn-primary btn-sm" onclick="uploadKeys()">ğŸ“¤ å¼€å§‹ä¸Šä¼ 
                                        (Upload)</button>
                                    <button class="btn btn-secondary btn-sm" onclick="loadKeys()">ğŸ”„ åˆ·æ–°
                                        (Refresh)</button>
                                </div>
                                <div id="keys-list-container"
                                    style="max-height: 300px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 4px;">
                                    <table style="font-size: 13px; width: 100%;">
                                        <thead>
                                            <tr>
                                                <th style="width: 30%">æ–‡ä»¶å</th>
                                                <th style="width: 15%">å¤§å°</th>
                                                <th style="width: 40%">å…³è”é¶æœº (Used By)</th>
                                                <th style="width: 15%">æ“ä½œ</th>
                                            </tr>
                                        </thead>
                                        <tbody id="keys-table-body">
                                            <tr>
                                                <td colspan="4" class="empty-placeholder">
                                                    è¯·ç‚¹å‡»åˆ·æ–°åŠ è½½...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </details>

                        <!-- Add Target & List -->
                        <form action="/add_target" method="post" enctype="multipart/form-data" class="flex-row"
                            style="margin-bottom: 20px;">
                            <input type="text" name="name" placeholder="Name (Opt)"
                                style="width: 100px; margin-right: 5px;">
                            <input type="text" name="ip" placeholder="IP Address" required>
                            <input type="text" name="port" placeholder="Port" value="22" style="width: 60px;">
                            <input type="text" name="user" placeholder="User" value="root" style="width: 80px;">
                            <input type="password" name="password" placeholder="Password">
                            <input type="file" name="key_file" style="width: 200px;"
                                title="Upload Private Key (Optional)">
                            <button type="submit" class="btn btn-primary">Add Target</button>
                        </form>

                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 40px;"></th>
                                    <th>IP</th>
                                    <th>Port</th>
                                    <th>User</th>
                                    <th>Key</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for t in targets %}
                                {% include 'target_main_row.html' %}
                                {% include 'target_detail_row.html' %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    </details>
                </div>



                <!-- Multi-Tab Console Section (Now part of Dashboard View) -->
                <div class="card" id="console-section" style="display: none;">
                    <div class="tabs-header" id="tabs-header">
                        <!-- Tabs will be injected here -->
                    </div>
                    <div id="tabs-content-container">
                        <!-- Tab contents will be injected here -->
                    </div>
                </div>
            </div>

            <!-- View: File Monitor -->
            <div id="view-monitor" class="view-section">
                <div class="header">
                    <h1>ğŸ“Š æ–‡ä»¶ç›‘æ§ (File Monitor)</h1>
                    <div class="flex-row">
                        <button class="btn btn-secondary" onclick="clearMonitorLogs()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
                    </div>
                </div>
                <div class="container">
                    <div class="card">
                        <div class="card-content" style="padding:0;">
                            <table style="width:100%; font-size:12px;">
                                <thead>
                                    <tr>
                                        <th style="padding:8px;">Time</th>
                                        <th style="padding:8px;">IP</th>
                                        <th style="padding:8px;">Event</th>
                                        <th style="padding:8px;">Details</th>
                                        <th style="padding:8px;">Raw</th>
                                    </tr>
                                </thead>
                                <tbody id="monitor-logs-body">
                                    <tr>
                                        <td colspan="5" class="empty-placeholder">ç­‰å¾…æ—¥å¿—...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Placeholder Views for Future Expansion -->
            <!-- View: Safety Alerts -->
            <div id="view-alerts" class="view-section">
                <div class="header">
                    <h1>ğŸš¨ å®‰å…¨å‘Šè­¦ (Security Alerts)</h1>
                    <div class="flex-row">
                        <button class="btn btn-danger" onclick="clearAlerts()">ğŸ—‘ï¸ æ¸…ç©ºå‘Šè­¦</button>
                        <div class="flex-row" style="margin-left:20px; align-items:center;">
                            <input type="checkbox" id="alert-sound-toggle" checked>
                            <label for="alert-sound-toggle"
                                style="margin-left:5px; font-size:12px; color:#666;">å£°éŸ³æé†’</label>
                        </div>
                    </div>
                </div>
                <div class="container">
                    <div id="alerts-list">
                        <div class="empty-msg" style="text-align:center; padding:40px; color:#666;">âœ… æš‚æ— å®‰å…¨å‘Šè­¦</div>
                    </div>
                </div>
            </div>

            <!-- View: Attack Module -->
            <div id="view-attacks" class="view-section">
                <div class="header">
                    <h1>âš”ï¸ Attack Module (Counter-Strike)</h1>
                    <div class="flex-row">
                        <span style="font-size:12px; opacity:0.7;">è‡ªåŠ¨ååˆ¶å·²å‘ç°çš„åé—¨</span>
                    </div>
                </div>
                <div class="container">
                    <!-- Config Card -->
                    <div class="card">
                        <h3>ğŸ¯ æ•Œæ–¹é…ç½® (Enemy Configuration)</h3>
                        <div class="card-content">
                            <div class="flex-row">
                                <label style="flex-basis: 150px;">æ•Œæ–¹ç½‘æ®µæ¨¡æ¿:</label>
                                <input type="text" id="attack-template"
                                    placeholder="e.g. 172.16.{x}.101 OR 10.0.1.5,10.0.1.6" style="flex-grow: 1;">
                                <span style="font-size:12px; color:#666;"> ä½¿ç”¨ {x} ä»£è¡¨å˜åŒ–æ®µï¼Œæˆ–è¾“å…¥é€—å·åˆ†éš”çš„ IP åˆ—è¡¨</span>
                            </div>
                            <div class="flex-row" style="margin-top:10px;">
                                <label style="flex-basis: 150px;">æ’é™¤ IP (é€—å·åˆ†éš”):</label>
                                <input type="text" id="attack-excluded" placeholder="e.g. 172.16.1.101"
                                    style="flex-grow: 1;">
                            </div>
                            <div class="flex-row" style="margin-top:15px;">
                                <button class="btn btn-primary" onclick="saveAttackConfig()">ğŸ’¾ ä¿å­˜é…ç½®</button>
                                <span id="attack-config-msg" style="margin-left:10px; font-size:12px;"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Status Wall -->
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h3 style="margin:0;">ğŸ“¡ å®æ—¶æˆ˜å†µ (Live Status)</h3>
                        <button class="btn btn-sm btn-secondary" onclick="loadAttackConfig()"
                            style="display:flex; align-items:center; gap:5px;">ğŸ”„ åˆ·æ–°æˆ˜å†µ</button>
                    </div>
                    <div id="attack-wall">
                        <!-- Cards will be injected here -->
                        <div class="empty-msg" style="text-align:center; padding:40px; color:#666; grid-column: 1/-1;">
                            â³ ç­‰å¾…è§¦å‘ååˆ¶ä»»åŠ¡...
                        </div>
                    </div>
                </div>
            </div>
            <div id="view-defense" class="view-section">
                <div class="header">
                    <h1>é˜²å¾¡æ¨¡å— (Defense)</h1>
                </div>
                <div class="container">
                    <div class="card">
                        <div class="card-content">ğŸš§ æ–½å·¥ä¸­...</div>
                    </div>
                </div>
            </div>
            <div id="view-settings" class="view-section">
                <div class="header">
                    <h1>ç³»ç»Ÿè®¾ç½® (Settings)</h1>
                </div>
                <div class="container">
                    <div class="card">
                        <div class="card-content">ğŸš§ æ–½å·¥ä¸­...</div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div id="toast"></div>

    <!-- Shared Modal Container (Body Level) -->
    <div id="file-editor-modal"
        style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:10000; align-items:center; justify-content:center;">
        <div
            style="background:var(--card-bg); width:85%; height:85%; border-radius:4px; display:flex; flex-direction:column; padding:20px; box-shadow: 0 0 30px rgba(0,0,0,0.5); border: 1px solid var(--primary-color); backdrop-filter: var(--glass-blur);">
            <div class="flex-row" style="margin-bottom:10px;">
                <h3 style="margin:0;" id="file-editor-title">Edit</h3>
                <span class="spacer"></span>
                <button class="btn btn-primary" id="file-editor-save-btn">ğŸ’¾ Save</button>
                <button class="btn btn-secondary"
                    onclick="document.getElementById('file-editor-modal').style.display='none'">Close</button>
            </div>
            <textarea id="file-editor-area"
                style="flex-grow:1; font-family: var(--font-mono, 'Consolas', monospace); resize:none; padding:10px; border:1px solid var(--border-color); background: var(--editor-bg); color: var(--text-color);"></textarea>
        </div>
    </div>

    <!-- JS Modules -->
    <script src="{{ url_for('static', filename='js/modules/utils.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/ssh.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/terminal.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/files.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/attack.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/defense.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/rules.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/keys.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/monitor.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/app.js') }}"></script>
</body>

</html>