<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AWD Controller</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
</head>

<body>

    <div class="app-layout">
        <!-- Sidebar -->
        <div class="app-sidebar">
            <div class="sidebar-header">
                <div class="sidebar-brand-icon">ğŸ›¡ï¸</div>
                <div class="sidebar-brand">AWD Defender</div>
            </div>
            <div class="sidebar-nav">
                <div class="nav-item active" onclick="switchView('dashboard', this)">
                    <div class="nav-icon">ğŸ“Š</div>
                    <div class="nav-text">æ§åˆ¶å° (Dashboard)</div>
                </div>
                <div class="nav-item" onclick="switchView('attacks', this)">
                    <div class="nav-icon">âš”ï¸</div>
                    <div class="nav-text">æ”»å‡» (Attack)</div>
                </div>
                <!-- 
                <div class="nav-item" onclick="switchView('defense', this)">
                    <div class="nav-icon">ğŸ›¡ï¸</div>
                    <div class="nav-text">é˜²å¾¡ (Defense)</div>
                </div>
                <div class="nav-item" onclick="switchView('settings', this)">
                    <div class="nav-icon">âš™ï¸</div>
                    <div class="nav-text">è®¾ç½® (Settings)</div>
                </div>
                -->
            </div>
            <!-- Bottom Actions -->
            <div
                style="padding: 10px; border-top: 1px solid var(--border-color); display:flex; flex-direction:column; gap:5px;">
                <div class="nav-item" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">
                    <div class="nav-icon">ğŸŒ“</div>
                    <div class="nav-text">åˆ‡æ¢ä¸»é¢˜</div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="app-main">

            <!-- View: Dashboard (Default) -->
            <div id="view-dashboard" class="view-section active">
                <div class="header">
                    <h1>AWD Controller</h1>
                    <div class="flex-row">
                        <button class="btn btn-primary" onclick="connectAll()">ğŸ”— å…¨éƒ¨è¿æ¥</button>
                        <button class="btn btn-secondary" onclick="disconnectAll()">â›“ï¸ å…¨éƒ¨æ–­å¼€</button>
                        <button class="btn btn-warning" onclick="batchExecutePrompt()">âš¡ æ‰¹é‡æ‰§è¡Œ</button>
                        <button class="btn btn-secondary" onclick="checkConnections()">ğŸ’“ æ£€æŸ¥è¿æ¥</button>
                    </div>
                </div>

                <div class="container">
                    <!-- Config & Targets Section (Original Content) -->
                    <div class="card">
                        <details open>
                            <summary>âš™ï¸ Configuration & Targets</summary>
                            <div class="card-content">
                                <!-- Preload, Scheduled Tasks, Rules, AOI, Target Form, Target List -->

                                <!-- Preload Config -->
                                <details style="margin-bottom: 20px;">
                                    <summary>âš™ï¸ Preload Tasks (Auto-run on Connect)</summary>
                                    <div class="card-content" style="padding-top: 10px;">
                                        <div class="flex-row" style="margin-bottom: 10px;">
                                            <input type="file" id="preload-file" style="width: 200px;">
                                            <input type="text" id="preload-path" placeholder="Remote Path"
                                                style="width: 200px;">
                                            <button class="btn btn-primary btn-sm" onclick="addPreloadFile()">Add
                                                File</button>
                                            <div style="width: 20px;"></div>
                                            <input type="text" id="preload-cmd" placeholder="Command"
                                                style="flex-grow: 1;">
                                            <button class="btn btn-primary btn-sm" onclick="addPreloadCmd()">Add
                                                Cmd</button>
                                        </div>

                                        <div
                                            style="max-height: 150px; overflow-y: auto; border: 1px solid var(--border-color); padding: 10px; border-radius: 4px;">
                                            {% for f in preload.files %}
                                            <div class="flex-row" style="margin-bottom: 5px; font-size: 12px;">
                                                <span>ğŸ“„ {{ f.filename }} &rarr; {{ f.remote_path }}</span>
                                                <span class="spacer"></span>
                                                <button class="btn btn-danger btn-sm"
                                                    onclick="removePreload('file', '{{ loop.index0 }}')">Ã—</button>
                                            </div>
                                            {% endfor %}
                                            {% for cmd in preload.commands %}
                                            <div class="flex-row" style="margin-bottom: 5px; font-size: 12px;">
                                                <span>ğŸ’» {{ cmd }}</span>
                                                <span class="spacer"></span>
                                                <button class="btn btn-danger btn-sm"
                                                    onclick="removePreload('cmd', '{{ loop.index0 }}')">Ã—</button>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </details>

                                <!-- å®šæ—¶ä»»åŠ¡ç®¡ç† -->
                                <details style="margin-bottom: 20px;">
                                    <summary>â° å®šæ—¶ä»»åŠ¡ (åœ¨æ‰€æœ‰å·²è¿æ¥é¶æœºä¸Šå®šæ—¶æ‰§è¡Œ)</summary>
                                    <div class="card-content" style="padding-top: 10px;">
                                        <div class="flex-row" style="margin-bottom: 10px;">
                                            <input type="text" id="task-name" placeholder="ä»»åŠ¡åç§°" style="width: 150px;">
                                            <input type="text" id="task-cmd" placeholder="å‘½ä»¤ (å¦‚: rm -f /tmp/*.php)"
                                                style="flex-grow: 1;">
                                            <input type="text" id="task-interval" placeholder="é—´éš”(ç§’)" value="300"
                                                style="width: 80px;">
                                            <button class="btn btn-primary btn-sm"
                                                onclick="addScheduledTask()">æ·»åŠ ä»»åŠ¡</button>
                                        </div>
                                        <div id="scheduled-tasks-list"
                                            style="max-height: 150px; overflow-y: auto; border: 1px solid var(--border-color); padding: 10px; border-radius: 4px; font-size: 12px; color: #999;">
                                            åŠ è½½ä¸­...
                                        </div>
                                    </div>
                                </details>

                                <!-- è‡ªå®šä¹‰ PHP æ£€æµ‹è§„åˆ™ -->
                                <details style="margin-bottom: 20px;">
                                    <summary>ğŸ›¡ï¸ è‡ªå®šä¹‰ PHP æ£€æµ‹è§„åˆ™ (è¡¥å……å†…ç½®æ‰«æçš„ grep æ­£åˆ™)</summary>
                                    <div class="card-content" style="padding-top: 10px;">
                                        <div class="flex-row" style="margin-bottom: 10px;">
                                            <input type="text" id="rule-name" placeholder="è§„åˆ™åç§°" style="width: 120px;">
                                            <input type="text" id="rule-pattern" placeholder="æ­£åˆ™è¡¨è¾¾å¼ (å¦‚: mysql_query\\()"
                                                style="flex-grow: 1;">
                                            <input type="text" id="rule-desc" placeholder="æè¿°(å¯é€‰)"
                                                style="width: 150px;">
                                            <button class="btn btn-primary btn-sm"
                                                onclick="addCustomRule()">æ·»åŠ è§„åˆ™</button>
                                        </div>
                                        <div id="custom-rules-list"
                                            style="max-height: 150px; overflow-y: auto; border: 1px solid var(--border-color); padding: 10px; border-radius: 4px; font-size: 12px; color: #999;">
                                            åŠ è½½ä¸­...
                                        </div>
                                    </div>
                                </details>

                                <!-- AOI å·¥å…·é…ç½® -->
                                <details style="margin-bottom: 20px;">
                                    <summary>ğŸ›¡ï¸ AOI æµé‡ç›‘æ§ (æ£€æµ‹åˆ° PHP é¶æœºåè‡ªåŠ¨éƒ¨ç½²)</summary>
                                    <div class="card-content" style="padding-top: 10px;">
                                        <div class="flex-row" style="margin-bottom: 10px; align-items:center;">
                                            <span style="font-size:12px; color:#999; white-space:nowrap;">æœ¬æœº IPï¼š</span>
                                            <input type="text" id="local-ip-input" placeholder="å¦‚: 10.4.51.119"
                                                value="{{ local_ip }}" style="width: 200px;">
                                            <button class="btn btn-primary btn-sm" onclick="saveLocalIp()">ä¿å­˜</button>
                                            <span id="local-ip-status" style="font-size:11px; margin-left:8px;"></span>
                                        </div>
                                        <div
                                            style="font-size:11px; color:#666; padding:6px 8px; background:var(--card-bg); border:1px solid var(--border-color); border-radius:4px;">
                                            <div>ğŸ“¦ <code>tapeworm.phar</code> â†’
                                                <code>php tapeworm.phar -d /var/www/html -s &lt;æœ¬æœºIP&gt;:8023</code>
                                            </div>
                                            <div>ğŸ“¦ <code>roundworm</code> â†’
                                                <code>./roundworm -d -s &lt;æœ¬æœºIP&gt; -w /var/www/html</code>
                                            </div>
                                            <div style="color:#f39c12; margin-top:4px;">âš ï¸ æœªé…ç½®æœ¬æœº IP æ—¶ä¸ä¼šè‡ªåŠ¨éƒ¨ç½²</div>
                                        </div>
                                    </div>
                                </details>

                                <!-- Add Target & List -->
                                <form action="/add_target" method="post" enctype="multipart/form-data" class="flex-row"
                                    style="margin-bottom: 20px;">
                                    <input type="text" name="name" placeholder="Name (Opt)"
                                        style="width: 100px; margin-right: 5px;">
                                    <input type="text" name="ip" placeholder="IP Address" required>
                                    <input type="text" name="port" placeholder="Port" value="22" style="width: 60px;">
                                    <input type="text" name="user" placeholder="User" value="root" style="width: 80px;">
                                    <input type="password" name="password" placeholder="Password">
                                    <input type="file" name="key_file" style="width: 200px;"
                                        title="Upload Private Key (Optional)">
                                    <button type="submit" class="btn btn-primary">Add Target</button>
                                </form>

                                <table>
                                    <thead>
                                        <tr>
                                            <th style="width: 40px;"></th>
                                            <th>IP</th>
                                            <th>Port</th>
                                            <th>User</th>
                                            <th>Key</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for t in targets %}
                                        {% include 'target_main_row.html' %}
                                        {% include 'target_detail_row.html' %}
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </details>
                    </div>

                    <!-- Multi-Tab Console Section (Now part of Dashboard View) -->
                    <div class="card" id="console-section" style="display: none;">
                        <div class="tabs-header" id="tabs-header">
                            <!-- Tabs will be injected here -->
                        </div>
                        <div id="tabs-content-container">
                            <!-- Tab contents will be injected here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Placeholder Views for Future Expansion -->
            <!-- View: Attack Module -->
            <div id="view-attacks" class="view-section">
                <div class="header">
                    <h1>âš”ï¸ Attack Module (Counter-Strike)</h1>
                    <div class="flex-row">
                        <span style="font-size:12px; opacity:0.7;">è‡ªåŠ¨ååˆ¶å·²å‘ç°çš„åé—¨</span>
                    </div>
                </div>
                <div class="container">
                    <!-- Config Card -->
                    <div class="card">
                        <h3>ğŸ¯ æ•Œæ–¹é…ç½® (Enemy Configuration)</h3>
                        <div class="card-content">
                            <div class="flex-row">
                                <label style="flex-basis: 150px;">æ•Œæ–¹ç½‘æ®µæ¨¡æ¿:</label>
                                <input type="text" id="attack-template"
                                    placeholder="e.g. 172.16.{x}.101 OR 10.0.1.5,10.0.1.6" style="flex-grow: 1;">
                                <span style="font-size:12px; color:#666;"> ä½¿ç”¨ {x} ä»£è¡¨å˜åŒ–æ®µï¼Œæˆ–è¾“å…¥é€—å·åˆ†éš”çš„ IP åˆ—è¡¨</span>
                            </div>
                            <div class="flex-row" style="margin-top:10px;">
                                <label style="flex-basis: 150px;">æ’é™¤ IP (é€—å·åˆ†éš”):</label>
                                <input type="text" id="attack-excluded" placeholder="e.g. 172.16.1.101"
                                    style="flex-grow: 1;">
                            </div>
                            <div class="flex-row" style="margin-top:15px;">
                                <button class="btn btn-primary" onclick="saveAttackConfig()">ğŸ’¾ ä¿å­˜é…ç½®</button>
                                <span id="attack-config-msg" style="margin-left:10px; font-size:12px;"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Status Wall -->
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h3 style="margin:0;">ğŸ“¡ å®æ—¶æˆ˜å†µ (Live Status)</h3>
                        <button class="btn btn-sm btn-secondary" onclick="loadAttackConfig()"
                            style="display:flex; align-items:center; gap:5px;">ğŸ”„ åˆ·æ–°æˆ˜å†µ</button>
                    </div>
                    <div id="attack-wall">
                        <!-- Cards will be injected here -->
                        <div class="empty-msg" style="text-align:center; padding:40px; color:#666; grid-column: 1/-1;">
                            â³ ç­‰å¾…è§¦å‘ååˆ¶ä»»åŠ¡...
                        </div>
                    </div>
                </div>
            </div>
            <div id="view-defense" class="view-section">
                <div class="header">
                    <h1>é˜²å¾¡æ¨¡å— (Defense)</h1>
                </div>
                <div class="container">
                    <div class="card">
                        <div class="card-content">ğŸš§ æ–½å·¥ä¸­...</div>
                    </div>
                </div>
            </div>
            <div id="view-settings" class="view-section">
                <div class="header">
                    <h1>ç³»ç»Ÿè®¾ç½® (Settings)</h1>
                </div>
                <div class="container">
                    <div class="card">
                        <div class="card-content">ğŸš§ æ–½å·¥ä¸­...</div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div id="toast"></div>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>

</html>