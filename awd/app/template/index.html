<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AWD Controller</title>
    <style>
        :root {
            --bg-color: #f4f6f8;
            --text-color: #2c3e50;
            --card-bg: #ffffff;
            --border-color: #dfe3e8;
            --primary-color: #3498db;
            --danger-color: #e74c3c;
            --success-color: #2ecc71;
            --warning-color: #f1c40f;
            --console-bg: #2d3436;
            --console-text: #f1f2f6;
            --shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        [data-theme="dark"] {
            --bg-color: #1a1a1a;
            --text-color: #ecf0f1;
            --card-bg: #2d2d2d;
            --border-color: #404040;
            --primary-color: #3498db;
            --danger-color: #e74c3c;
            --success-color: #2ecc71;
            --warning-color: #f1c40f;
            --console-bg: #000000;
            --console-text: #00ff00;
            --shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            transition: background-color 0.3s, color 0.3s;
        }

        .header {
            background-color: var(--card-bg);
            padding: 15px 30px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
        }

        .header h1 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
        }

        .container {
            padding: 20px;
            max-width: 1600px;
            margin: 0 auto;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        details {
            width: 100%;
        }

        summary {
            padding: 15px;
            cursor: pointer;
            font-weight: 600;
            background-color: rgba(0, 0, 0, 0.02);
            border-bottom: 1px solid var(--border-color);
            outline: none;
            user-select: none;
        }

        summary:hover {
            background-color: rgba(0, 0, 0, 0.04);
        }

        .card-content {
            padding: 20px;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .target-row:hover {
            background-color: rgba(0, 0, 0, 0.03);
        }

        th {
            font-weight: 600;
            color: var(--text-color);
            opacity: 0.8;
        }

        .status-cell {
            color: var(--text-color);
        }

        .status-cell[data-status="connected"] {
            color: var(--success-color);
        }

        .status-cell[data-status="error"] {
            color: var(--danger-color);
        }

        /* Inputs & Buttons */
        input[type="text"],
        input[type="password"],
        input[type="file"] {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--bg-color);
            color: var(--text-color);
            outline: none;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: opacity 0.2s;
            color: white;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .btn-primary {
            background-color: var(--primary-color);
        }

        .btn-danger {
            background-color: var(--danger-color);
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: #333;
        }

        .btn-secondary {
            background-color: #95a5a6;
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 12px;
        }

        /* Tabs */
        .tabs-header {
            display: flex;
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            overflow-x: auto;
        }

        .tab-btn {
            padding: 12px 20px;
            cursor: pointer;
            border-right: 1px solid var(--border-color);
            background: transparent;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab-btn.active {
            background-color: var(--bg-color);
            border-bottom: 2px solid var(--primary-color);
            font-weight: 600;
        }

        .tab-btn:hover:not(.active) {
            background-color: rgba(0, 0, 0, 0.02);
        }

        .close-tab {
            margin-left: 8px;
            opacity: 0.5;
            cursor: pointer;
        }

        .close-tab:hover {
            opacity: 1;
            color: var(--danger-color);
        }

        .tab-content {
            display: none;
            padding: 20px;
            background-color: var(--bg-color);
            height: 600px;
            flex-direction: column;
        }

        .tab-content.active {
            display: flex;
        }

        .console-output {
            flex-grow: 1;
            background-color: var(--console-bg);
            color: var(--console-text);
            font-family: 'Consolas', monospace;
            padding: 15px;
            border-radius: 4px;
            overflow-y: auto;
            margin-bottom: 15px;
            white-space: pre-wrap;
            font-size: 13px;
        }

        .console-input-area {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .console-input {
            flex-grow: 1;
            font-family: monospace;
        }

        .flex-row {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .spacer {
            flex-grow: 1;
        }

        /* Toast */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 4px;
            padding: 12px;
            position: fixed;
            z-index: 1000;
            left: 50%;
            transform: translateX(-50%);
            bottom: 30px;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        #toast.show {
            visibility: visible;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }

        @keyframes fadein {
            from {
                bottom: 0;
                opacity: 0;
            }

            to {
                bottom: 30px;
                opacity: 1;
            }
        }

        @keyframes fadeout {
            from {
                bottom: 30px;
                opacity: 1;
            }

            to {
                bottom: 0;
                opacity: 0;
            }
        }
    </style>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
</head>

<body>

    <div class="header">
        <h1>AWD Controller</h1>
        <div class="flex-row">
            <button class="btn btn-primary" onclick="connectAll()">ğŸ”— å…¨éƒ¨è¿æ¥</button>
            <button class="btn btn-secondary" onclick="disconnectAll()">â›“ï¸ å…¨éƒ¨æ–­å¼€</button>
            <button class="btn btn-warning" onclick="batchExecutePrompt()">âš¡ æ‰¹é‡æ‰§è¡Œ</button>
            <button class="btn btn-secondary" onclick="checkConnections()">ğŸ’“ æ£€æŸ¥è¿æ¥</button>
            <button class="btn btn-secondary" onclick="toggleTheme()">ğŸŒ“ Theme</button>
        </div>
    </div>

    <div class="container">

        <!-- Config & Targets Section (Collapsible) -->
        <div class="card">
            <details open>
                <summary>âš™ï¸ Configuration & Targets</summary>
                <div class="card-content">

                    <!-- Preload Config -->
                    <div style="margin-bottom: 30px;">
                        <h4 style="margin-top: 0;">Preload Tasks (Auto-run on Connect)</h4>
                        <div class="flex-row" style="margin-bottom: 10px;">
                            <input type="file" id="preload-file" aria-label="Preload File" style="width: 200px;">
                            <input type="text" id="preload-path" aria-label="Remote Path" placeholder="Remote Path"
                                style="width: 200px;">
                            <button class="btn btn-primary btn-sm" onclick="addPreloadFile()">Add File</button>
                            <div style="width: 20px;"></div>
                            <input type="text" id="preload-cmd" aria-label="Command" placeholder="Command"
                                style="flex-grow: 1;">
                            <button class="btn btn-primary btn-sm" onclick="addPreloadCmd()">Add Cmd</button>
                        </div>

                        <div
                            style="max-height: 150px; overflow-y: auto; border: 1px solid var(--border-color); padding: 10px; border-radius: 4px;">
                            {% for f in preload.files %}
                            <div class="flex-row" style="margin-bottom: 5px; font-size: 12px;">
                                <span>ğŸ“„ {{ f.filename }} &rarr; {{ f.remote_path }}</span>
                                <span class="spacer"></span>
                                <button class="btn btn-danger btn-sm"
                                    onclick="removePreload('file', '{{ loop.index0 }}')">Ã—</button>
                            </div>
                            {% endfor %}
                            {% for cmd in preload.commands %}
                            <div class="flex-row" style="margin-bottom: 5px; font-size: 12px;">
                                <span>ğŸ’» {{ cmd }}</span>
                                <span class="spacer"></span>
                                <button class="btn btn-danger btn-sm"
                                    onclick="removePreload('cmd', '{{ loop.index0 }}')">Ã—</button>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- å®šæ—¶ä»»åŠ¡ç®¡ç† -->
                    <div style="margin-bottom: 30px;">
                        <h4 style="margin-top: 20px;">â° å®šæ—¶ä»»åŠ¡ (åœ¨æ‰€æœ‰å·²è¿æ¥é¶æœºä¸Šå®šæ—¶æ‰§è¡Œ)</h4>
                        <div class="flex-row" style="margin-bottom: 10px;">
                            <input type="text" id="task-name" aria-label="ä»»åŠ¡åç§°" placeholder="ä»»åŠ¡åç§°"
                                style="width: 150px;">
                            <input type="text" id="task-cmd" aria-label="å‘½ä»¤" placeholder="å‘½ä»¤ (å¦‚: rm -f /tmp/*.php)"
                                style="flex-grow: 1;">
                            <input type="text" id="task-interval" aria-label="é—´éš”ç§’æ•°" placeholder="é—´éš”(ç§’)" value="300"
                                style="width: 80px;">
                            <button class="btn btn-primary btn-sm" onclick="addScheduledTask()">æ·»åŠ ä»»åŠ¡</button>
                        </div>
                        <div id="scheduled-tasks-list"
                            style="max-height: 150px; overflow-y: auto; border: 1px solid var(--border-color); padding: 10px; border-radius: 4px; font-size: 12px; color: #999;">
                            åŠ è½½ä¸­...
                        </div>
                    </div>

                    <hr style="border: 0; border-top: 1px solid var(--border-color); margin: 20px 0;">

                    <!-- è‡ªå®šä¹‰ PHP æ£€æµ‹è§„åˆ™ -->
                    <div style="margin-bottom: 30px;">
                        <h4>ğŸ›¡ï¸ è‡ªå®šä¹‰ PHP æ£€æµ‹è§„åˆ™ (è¡¥å……å†…ç½®æ‰«æçš„ grep æ­£åˆ™)</h4>
                        <div class="flex-row" style="margin-bottom: 10px;">
                            <input type="text" id="rule-name" placeholder="è§„åˆ™åç§°" style="width: 120px;">
                            <input type="text" id="rule-pattern" placeholder="æ­£åˆ™è¡¨è¾¾å¼ (å¦‚: mysql_query\\()"
                                style="flex-grow: 1;">
                            <input type="text" id="rule-desc" placeholder="æè¿°(å¯é€‰)" style="width: 150px;">
                            <button class="btn btn-primary btn-sm" onclick="addCustomRule()">æ·»åŠ è§„åˆ™</button>
                        </div>
                        <div id="custom-rules-list"
                            style="max-height: 150px; overflow-y: auto; border: 1px solid var(--border-color); padding: 10px; border-radius: 4px; font-size: 12px; color: #999;">
                            åŠ è½½ä¸­...
                        </div>
                    </div>

                    <hr style="border: 0; border-top: 1px solid var(--border-color); margin: 20px 0;">

                    <!-- AOI å·¥å…·é…ç½® -->
                    <div style="margin-bottom: 30px;">
                        <h4>ğŸ›¡ï¸ AOI æµé‡ç›‘æ§ (æ£€æµ‹åˆ° PHP é¶æœºåè‡ªåŠ¨éƒ¨ç½²)</h4>
                        <div class="flex-row" style="margin-bottom: 10px; align-items:center;">
                            <span style="font-size:12px; color:#999; white-space:nowrap;">æœ¬æœº IPï¼š</span>
                            <input type="text" id="local-ip-input" placeholder="å¦‚: 10.4.51.119" value="{{ local_ip }}"
                                style="width: 200px;">
                            <button class="btn btn-primary btn-sm" onclick="saveLocalIp()">ä¿å­˜</button>
                            <span id="local-ip-status" style="font-size:11px; margin-left:8px;"></span>
                        </div>
                        <div
                            style="font-size:11px; color:#666; padding:6px 8px; background:var(--card-bg); border:1px solid var(--border-color); border-radius:4px;">
                            <div>ğŸ“¦ <code>tapeworm.phar</code> â†’
                                <code>php tapeworm.phar -d /var/www/html -s &lt;æœ¬æœºIP&gt;:8023</code>
                            </div>
                            <div>ğŸ“¦ <code>roundworm</code> â†’
                                <code>./roundworm -d -s &lt;æœ¬æœºIP&gt; -w /var/www/html</code>
                            </div>
                            <div style="color:#f39c12; margin-top:4px;">âš ï¸ æœªé…ç½®æœ¬æœº IP æ—¶ä¸ä¼šè‡ªåŠ¨éƒ¨ç½²</div>
                        </div>
                    </div>

                    <hr style="border: 0; border-top: 1px solid var(--border-color); margin: 20px 0;">

                    <!-- Add Target -->
                    <form action="/add_target" method="post" enctype="multipart/form-data" class="flex-row"
                        style="margin-bottom: 20px;">
                        <input type="text" name="ip" aria-label="IP Address" placeholder="IP Address" required>
                        <input type="text" name="port" aria-label="Port" placeholder="Port" value="22"
                            style="width: 60px;">
                        <input type="text" name="user" aria-label="User" placeholder="User" value="root"
                            style="width: 80px;">
                        <input type="password" name="password" aria-label="Password" placeholder="Password">
                        <input type="file" name="key_file" aria-label="Key File" style="width: 200px;"
                            title="Upload Private Key (Optional)">
                        <button type="submit" class="btn btn-primary">Add Target</button>
                    </form>

                    <!-- Target List -->
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 40px;"></th> <!-- Expand Icon -->
                                <th>IP</th>
                                <th>Port</th>
                                <th>User</th>
                                <th>Key</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for t in targets %}
                            {% include 'target_main_row.html' %}
                            {% include 'target_detail_row.html' %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </details>
        </div>

        <!-- Multi-Tab Console Section -->
        <div class="card" id="console-section" style="display: none;">
            <div class="tabs-header" id="tabs-header">
                <!-- Tabs will be injected here -->
            </div>
            <div id="tabs-content-container">
                <!-- Tab contents will be injected here -->
            </div>
        </div>

    </div>

    <div id="toast"></div>

    <script>
        // Theme Logic
        function toggleTheme() {
            const html = document.documentElement;
            const current = html.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
        }

        // Init Theme
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);

        // Toast Logic
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.className = 'show';
            setTimeout(() => t.className = t.className.replace('show', ''), 3000);
        }

        // --- API Calls ---
        async function apiCall(url, data) {
            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                return await res.json();
            } catch (e) {
                showToast("Error: " + e);
                return null;
            }
        }

        async function connect(ip, port) {
            showToast("Connecting to " + ip + ":" + port + "...");
            const data = await apiCall('/api/connect', { ip, port });
            if (data) {
                showToast(data.message);
                if (data.success) {
                    // Update happens via WebSocket, no need to reload
                } else {
                    setTimeout(() => location.reload(), 500); // Fallback
                }
            }
        }

        async function disconnect(ip, port) {
            const data = await apiCall('/api/disconnect', { ip, port });
            if (data) {
                showToast(data.message);
            }
        }

        async function removeTarget(ip, port) {
            if (!confirm('Remove target ' + ip + ':' + port + '?')) return;
            const data = await apiCall('/api/remove_target', { ip, port });
            if (data && data.status === 'ok') {
                showToast("Removed");
            }
        }

        async function updatePassword(ip, port) {
            const password = prompt("Enter new password for " + ip + ":" + port + ":");
            if (password === null) return; // Cancelled
            showToast("Updating password...");
            const data = await apiCall('/api/update_password', { ip, port, password });
            if (data) {
                showToast(data.message);
            }
        }

        async function rerunPreload(ip, port) {
            if (!confirm('Rerun preload tasks for ' + ip + ':' + port + '?')) return;
            showToast("Queueing preload tasks...");
            const data = await apiCall('/api/rerun_preload', { ip, port });
            if (data) showToast(data.message);
        }

        async function rerunBackup(ip, port) {
            if (!confirm('é‡æ–°å¤‡ä»½ ' + ip + ':' + port + '?')) return;
            showToast("å¤‡ä»½ä»»åŠ¡å·²å¯åŠ¨...");
            const data = await apiCall('/api/rerun_backup', { ip, port });
            if (data) showToast(data.message);
        }

        // --- åé—¨æ£€æµ‹ ---
        async function snapshotFiles(ip, port) {
            if (!confirm('ä¸º ' + ip + ':' + port + ' å»ºç«‹æ–‡ä»¶å¿«ç…§åŸºçº¿ï¼Ÿ\nè¿™å°†è®°å½•å½“å‰æ‰€æœ‰æ–‡ä»¶çš„ MD5ï¼Œç”¨äºåç»­å¯¹æ¯”ã€‚')) return;
            showToast('æ­£åœ¨å»ºç«‹å¿«ç…§...');
            const data = await apiCall('/api/snapshot', { ip, port });
            if (data) showToast(data.message);
        }

        async function scanBackdoor(ip, port) {
            showToast('æ­£åœ¨æ‰«æåé—¨...');
            const data = await apiCall('/api/scan_backdoor', { ip, port });
            if (data) {
                showToast(data.message);
            }
        }

        async function restoreBackup(ip, port) {
            if (!confirm('âš ï¸ ç¡®å®šè¦è¿˜åŸ ' + ip + ':' + port + ' çš„å¤‡ä»½å—ï¼Ÿ\næ­¤æ“ä½œå°†è¦†ç›–é¶æœºä¸Šçš„å½“å‰æ–‡ä»¶ï¼')) return;
            showToast('æ­£åœ¨è¿˜åŸå¤‡ä»½...');
            const data = await apiCall('/api/restore_backup', { ip, port });
            if (data) showToast(data.message);
        }

        // --- æ‰¹é‡æ“ä½œ ---
        async function connectAll() {
            if (!confirm('ç¡®å®šè¦è¿æ¥æ‰€æœ‰é¶æœºå—ï¼Ÿ')) return;
            showToast('æ­£åœ¨è¿æ¥æ‰€æœ‰é¶æœº...');
            const data = await apiCall('/api/connect_all', {});
            if (data) {
                showToast(data.message);
            }
        }

        async function disconnectAll() {
            if (!confirm('ç¡®å®šè¦æ–­å¼€æ‰€æœ‰é¶æœºå—ï¼Ÿ')) return;
            const data = await apiCall('/api/disconnect_all', {});
            if (data) {
                showToast('å·²æ–­å¼€æ‰€æœ‰è¿æ¥');
            }
        }

        async function batchExecutePrompt() {
            const cmd = prompt('åœ¨æ‰€æœ‰å·²è¿æ¥é¶æœºä¸Šæ‰§è¡Œå‘½ä»¤:');
            if (!cmd) return;
            showToast('æ­£åœ¨æ‰¹é‡æ‰§è¡Œ...');
            const data = await apiCall('/api/batch_execute', { cmd });
            if (data && data.results) {
                let msg = 'æ‰¹é‡æ‰§è¡Œç»“æœ:\n';
                for (const [key, output] of Object.entries(data.results)) {
                    msg += `\n[${key}]\n${output}\n`;
                }
                alert(msg);
            }
        }

        async function checkConnections() {
            showToast('æ­£åœ¨æ£€æŸ¥è¿æ¥...');
            const data = await apiCall('/api/check_connections', {});
            if (data && data.results) {
                let dead = data.results.filter(r => !r.alive);
                if (dead.length === 0) {
                    showToast('æ‰€æœ‰è¿æ¥æ­£å¸¸ âœ…');
                } else {
                    showToast(`${dead.length} ä¸ªè¿æ¥å·²æ–­å¼€`);
                }
            }
        }

        // --- AOI å·¥å…· ---
        async function saveLocalIp() {
            const ip = document.getElementById('local-ip-input').value.trim();
            const status = document.getElementById('local-ip-status');
            const data = await apiCall('/api/local_ip', { ip });
            if (data && data.status === 'ok') {
                status.innerHTML = '<span style="color:var(--success-color);">âœ… å·²ä¿å­˜</span>';
                showToast('æœ¬æœº IP å·²ä¿å­˜: ' + ip);
                setTimeout(() => status.innerHTML = '', 3000);
            }
        }

        async function deployAoi(ip, port) {
            if (!confirm('éƒ¨ç½² AOI å·¥å…·åˆ° ' + ip + ':' + port + '?')) return;
            showToast('AOI éƒ¨ç½²å·²å¯åŠ¨...');
            await apiCall('/api/deploy_aoi', { ip, port });
        }

        // --- å®šæ—¶ä»»åŠ¡ ---
        async function loadScheduledTasks() {
            try {
                const res = await fetch('/api/scheduled_tasks');
                const data = await res.json();
                const container = document.getElementById('scheduled-tasks-list');
                const tasks = data.tasks || {};
                const entries = Object.entries(tasks);
                if (entries.length === 0) {
                    container.innerHTML = '<span style="color: #999;">æš‚æ— å®šæ—¶ä»»åŠ¡</span>';
                    return;
                }
                container.innerHTML = entries.map(([name, task]) => `
                    <div class="flex-row" style="margin-bottom: 5px;">
                        <span>â° <strong>${name}</strong> â†’ ${task.cmd} (æ¯ ${task.interval}s)</span>
                        <span class="spacer"></span>
                        <button class="btn btn-danger btn-sm" onclick="removeScheduledTask('${name}')">Ã—</button>
                    </div>
                `).join('');
            } catch (e) {
                console.error('åŠ è½½å®šæ—¶ä»»åŠ¡å¤±è´¥', e);
            }
        }

        async function addScheduledTask() {
            const name = document.getElementById('task-name').value;
            const cmd = document.getElementById('task-cmd').value;
            const interval = parseInt(document.getElementById('task-interval').value) || 300;
            if (!name || !cmd) return showToast('è¯·å¡«å†™ä»»åŠ¡åç§°å’Œå‘½ä»¤');
            const data = await apiCall('/api/scheduled_task/add', { name, cmd, interval });
            if (data) {
                showToast(data.message || 'å·²æ·»åŠ ');
                document.getElementById('task-name').value = '';
                document.getElementById('task-cmd').value = '';
                loadScheduledTasks();
            }
        }

        async function removeScheduledTask(name) {
            if (!confirm('ç§»é™¤å®šæ—¶ä»»åŠ¡ "' + name + '"?')) return;
            const data = await apiCall('/api/scheduled_task/remove', { name });
            if (data) {
                showToast(data.message || 'å·²ç§»é™¤');
                loadScheduledTasks();
            }
        }

        // é¡µé¢åŠ è½½æ—¶åŠ è½½å®šæ—¶ä»»åŠ¡åˆ—è¡¨
        document.addEventListener('DOMContentLoaded', loadScheduledTasks);

        // --- Preload Logic ---
        async function addPreloadFile() {
            const fileInput = document.getElementById('preload-file');
            const pathInput = document.getElementById('preload-path');
            if (!fileInput.files[0] || !pathInput.value) return showToast("File and Path required");

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('remote_path', pathInput.value);

            try {
                const res = await fetch('/api/preload/add_file', { method: 'POST', body: formData });
                if (res.ok) location.reload();
            } catch (e) { showToast("Error uploading"); }
        }

        async function addPreloadCmd() {
            const cmd = document.getElementById('preload-cmd').value;
            if (!cmd) return;
            const data = await apiCall('/api/preload/add_cmd', { cmd });
            if (data && data.status === 'ok') location.reload();
        }

        async function removePreload(type, index) {
            index = parseInt(index);
            if (!confirm('Remove?')) return;
            const data = await apiCall('/api/preload/remove', { type, index });
            if (data && data.status === 'ok') location.reload();
        }

        function openXshell(ip, port, user, password) {
            apiCall('/api/open_xshell', { ip, port, user, password }).then(d => {
                if (d) showToast(d.message);
            });
        }

        // --- Multi-Tab Console Logic ---
        const openTabs = new Set();
        let activeTabKey = null; // Changed from activeTabIp

        function openConsoleTab(ip, port) {
            document.getElementById('console-section').style.display = 'block';
            const key = ip + ':' + port;

            if (openTabs.has(key)) {
                activateTab(key);
                return;
            }

            openTabs.add(key);

            // Create Tab Button
            const header = document.getElementById('tabs-header');
            const btn = document.createElement('div');
            btn.className = 'tab-btn';
            btn.id = 'tab-btn-' + key.replace(/[:.]/g, '-');
            btn.innerHTML = `<span>${key}</span> <span class="close-tab" onclick="closeTab(event, '${ip}', '${port}')">Ã—</span>`;
            btn.onclick = () => activateTab(key);
            header.appendChild(btn);

            // Create Tab Content
            const container = document.getElementById('tabs-content-container');
            const content = document.createElement('div');
            content.className = 'tab-content';
            content.id = 'tab-content-' + key.replace(/[:.]/g, '-');
            content.innerHTML = `
            <div class="console-output" id="output-${key.replace(/[:.]/g, '-')}">Connecting to console... Ready.</div>
            <div class="console-input-area">
                <input type="text" class="console-input" id="input-${key.replace(/[:.]/g, '-')}" aria-label="Console Input" placeholder="Enter command..." onkeydown="if(event.key==='Enter') runConsoleCmd('${ip}', '${port}')">
                <button class="btn btn-primary" onclick="runConsoleCmd('${ip}', '${port}')">Run</button>
                <button class="btn btn-secondary btn-sm" onclick="openFileManager('${ip}', '${port}')">ğŸ“ Files</button>
            </div>
            <div class="flex-row">
                <input type="file" id="file-${key.replace(/[:.]/g, '-')}" aria-label="Upload File" style="width: 200px;">
                <input type="text" id="path-${key.replace(/[:.]/g, '-')}" aria-label="Remote Path" placeholder="Remote Path" style="width: 200px;">
                <button class="btn btn-secondary btn-sm" onclick="uploadConsoleFile('${ip}', '${port}')">Upload</button>
            </div>
        `;
            container.appendChild(content);

            activateTab(key);
        }

        function closeTab(e, ip, port) {
            e.stopPropagation();
            const key = ip + ':' + port;
            const safeKey = key.replace(/[:.]/g, '-');

            openTabs.delete(key);
            document.getElementById('tab-btn-' + safeKey).remove();
            document.getElementById('tab-content-' + safeKey).remove();

            if (activeTabKey === key) {
                activeTabKey = null;
                // Switch to another tab if exists
                if (openTabs.size > 0) {
                    activateTab(openTabs.values().next().value);
                } else {
                    document.getElementById('console-section').style.display = 'none';
                }
            }
        }

        function activateTab(key) {
            activeTabKey = key;
            const safeKey = key.replace(/[:.]/g, '-');

            // Update buttons
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            const btn = document.getElementById('tab-btn-' + safeKey);
            if (btn) btn.classList.add('active');

            // Update content
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            const content = document.getElementById('tab-content-' + safeKey);
            if (content) content.classList.add('active');
        }

        // WebSocket è¿æ¥ï¼ˆå¦‚æœ Socket.IO å¯ç”¨ï¼‰
        let wsSocket = null;
        try {
            wsSocket = io();
            wsSocket.on('connected', (data) => console.log('WebSocket:', data.message));
            wsSocket.on('ws_output', (data) => {
                const key = data.ip + ':' + data.port;
                const safeKey = key.replace(/[:.]/g, '-');
                const output = document.getElementById('output-' + safeKey);
                if (output) {
                    output.innerText += `\n${data.output}`;
                    output.scrollTop = output.scrollHeight;
                }
                // æ›´æ–° cwd æç¤ºç¬¦
                if (data.cwd) {
                    consoleCwd[key] = data.cwd;
                    const input = document.getElementById('input-' + safeKey);
                    if (input) input.placeholder = data.cwd + '$ ';
                }
            });
            wsSocket.on('ws_output_wd', (data) => {
                const key = 'wd-' + data.ip + ':' + data.port;
                const safeKey = key.replace(/[:.]/g, '-');
                const output = document.getElementById('wd-output-' + safeKey);
                if (output) {
                    output.innerText += `\n${data.output}`;
                    output.scrollTop = output.scrollHeight;
                }
            });

            // Target Status Update
            wsSocket.on('target_update', (data) => {
                console.log('Received target_update:', data);
                const target = data.target;
                const html_main = data.html_main; // Note: services.py emits html_main and html_detail separately now?
                // Wait, in Step 724 (View services.py), I see:
                // 'html_main': html_main, 'html_detail': html_detail
                // So I need to update my JS to handle this!

                if (!target || !target.ip || !target.port) return;

                const safeIp = target.ip.replace(/\./g, '-');
                const rowId = 'target-' + safeIp + '-' + target.port;
                const detailRowId = 'detail-' + safeIp + '-' + target.port;

                const existingRow = document.getElementById(rowId);
                const existingDetail = document.getElementById(detailRowId);
                const tbody = document.querySelector('table tbody');

                if (data.action === 'remove') {
                    if (existingRow) existingRow.remove();
                    if (existingDetail) existingDetail.remove();
                    return;
                }

                // For update or add
                if (data.html_main) {
                    // Update Main Row
                    const tempMain = document.createElement('tbody');
                    tempMain.innerHTML = data.html_main;
                    const newMainRow = tempMain.firstElementChild;

                    if (existingRow) {
                        existingRow.replaceWith(newMainRow);
                    } else {
                        tbody.appendChild(newMainRow);
                    }
                }

                if (data.html_detail) {
                    // Update Detail Row
                    const tempDetail = document.createElement('tbody');
                    tempDetail.innerHTML = data.html_detail;
                    const newDetailRow = tempDetail.firstElementChild;

                    if (existingDetail) {
                        // Preserve display state
                        newDetailRow.style.display = existingDetail.style.display;
                        existingDetail.replaceWith(newDetailRow);
                    } else {
                        // If new row added, detail row comes after main row
                        const currentMain = document.getElementById(rowId);
                        if (currentMain) {
                            currentMain.after(newDetailRow);
                        }
                    }
                }

                // Re-sync icon state if detail is open
                const newDetail = document.getElementById(detailRowId);
                const newIcon = document.getElementById('icon-' + safeIp + '-' + target.port);
                if (newDetail && newDetail.style.display !== 'none' && newIcon) {
                    newIcon.style.transform = 'rotate(90deg)';
                }
            });
        } catch (e) {
            console.warn('WebSocket ä¸å¯ç”¨ï¼Œå›é€€åˆ° HTTP æ¨¡å¼');
        }

        // Console cwd ç¼“å­˜
        const consoleCwd = {};

        async function runConsoleCmd(ip, port) {
            const key = ip + ':' + port;
            const safeKey = key.replace(/[:.]/g, '-');
            const input = document.getElementById('input-' + safeKey);
            const output = document.getElementById('output-' + safeKey);
            const cmd = input.value;
            if (!cmd) return;

            const cwd = consoleCwd[key] || '~';
            output.innerText += `\n${cwd}$ ${cmd}`;
            input.value = '';
            output.scrollTop = output.scrollHeight;

            // ä¼˜å…ˆä½¿ç”¨ WebSocket
            if (wsSocket && wsSocket.connected) {
                wsSocket.emit('ws_execute', { ip, port: parseInt(port), cmd });
            } else {
                const data = await apiCall('/api/execute_console', { ip, port, cmd });
                if (data) {
                    output.innerText += `\n${data.output}`;
                    output.scrollTop = output.scrollHeight;
                    if (data.cwd) {
                        consoleCwd[key] = data.cwd;
                        input.placeholder = data.cwd + '$ ';
                    }
                }
            }
        }

        // --- www-data æƒé™ç»ˆç«¯ ---
        function openWwwdataTab(ip, port) {
            const key = 'wd-' + ip + ':' + port;
            document.getElementById('console-section').style.display = 'block';

            if (openTabs.has(key)) {
                activateTab(key);
                return;
            }
            openTabs.add(key);

            // Tab button
            const bar = document.getElementById('tab-bar');
            // Check if tab-bar exists? tab-bar is not defined in HTML?
            // Actually main tabs use 'tabs-header'.
            // wait, openWwwdataTab logic in original code referenced 'tab-bar' which is probably wrong or I missed it.
            // Oh, original code used 'console-section' and 'tabs-header'.
            // But line 1153 in view 664 is `const bar = document.getElementById('tab-bar');`
            // Let's check `tabs-header`.
            const header = document.getElementById('tabs-header');

            const btn = document.createElement('div');
            btn.className = 'tab-btn';
            btn.id = 'tab-btn-' + key.replace(/[:.]/g, '-');
            btn.innerHTML = `<span onclick="activateTab('${key}')">\uD83D\uDD36 ${ip}:${port} (www-data)</span><span class="close-tab" onclick="closeWdTab(event, '${ip}', '${port}')">&times;</span>`;
            header.appendChild(btn);

            // Tab content
            const container = document.getElementById('tabs-content-container');
            const content = document.createElement('div');
            content.className = 'tab-content';
            content.id = 'tab-content-' + key.replace(/[:.]/g, '-');
            content.innerHTML = `
            <pre id="wd-output-${key.replace(/[:.]/g, '-')}" style="background:#1a1a2e; color:#e67e22; padding:10px; max-height:300px; overflow-y:auto; border-radius:4px; margin-bottom:10px;">www-data@${ip}:${port}$ (SUID bash via /tmp/mujica)</pre>
            <div class="flex-row">
                <input type="text" id="wd-input-${key.replace(/[:.]/g, '-')}" placeholder="www-data$ å‘½ä»¤..." style="flex-grow:1;" onkeydown="if(event.key==='Enter') runWwwdataCmd('${ip}','${port}')">
                <button class="btn" style="background:#e67e22; color:white;" onclick="runWwwdataCmd('${ip}','${port}')">Run</button>
            </div>
            `;
            container.appendChild(content);
            activateTab(key);
        }

        function closeWdTab(e, ip, port) {
            e.stopPropagation();
            const key = 'wd-' + ip + ':' + port;
            const safeKey = key.replace(/[:.]/g, '-');
            openTabs.delete(key);
            document.getElementById('tab-btn-' + safeKey).remove();
            document.getElementById('tab-content-' + safeKey).remove();
            if (activeTabKey === key) {
                activeTabKey = null;
                if (openTabs.size > 0) {
                    activateTab(openTabs.values().next().value);
                } else {
                    document.getElementById('console-section').style.display = 'none';
                }
            }
        }

        async function runWwwdataCmd(ip, port) {
            const key = 'wd-' + ip + ':' + port;
            const safeKey = key.replace(/[:.]/g, '-');
            const input = document.getElementById('wd-input-' + safeKey);
            const output = document.getElementById('wd-output-' + safeKey);
            const cmd = input.value;
            if (!cmd) return;

            output.innerText += `\nwww-data$ ${cmd}`;
            input.value = '';
            output.scrollTop = output.scrollHeight;

            // ä¼˜å…ˆä½¿ç”¨ WebSocket
            if (wsSocket && wsSocket.connected) {
                wsSocket.emit('ws_execute_wwwdata', { ip, port: parseInt(port), cmd });
            } else {
                const data = await apiCall('/api/execute_wwwdata', { ip, port, cmd });
                if (data) {
                    output.innerText += `\n${data.output}`;
                    output.scrollTop = output.scrollHeight;
                }
            }
        }

        async function uploadConsoleFile(ip, port) {
            const key = ip + ':' + port;
            const safeKey = key.replace(/[:.]/g, '-');

            const fileInput = document.getElementById('file-' + safeKey);
            const pathInput = document.getElementById('path-' + safeKey);

            if (!fileInput.files[0] || !pathInput.value) return showToast("File and Path required");

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('ip', ip);
            formData.append('port', port);
            formData.append('remote_path', pathInput.value);

            showToast("Uploading...");
            try {
                const res = await fetch('/api/upload', { method: 'POST', body: formData });
                const data = await res.json();
                showToast(data.message);
                if (data.success) {
                    const output = document.getElementById('output-' + safeKey);
                    output.innerText += `\n[System] Uploaded ${fileInput.files[0].name} to ${pathInput.value}`;
                    output.scrollTop = output.scrollHeight;
                }
            } catch (e) { showToast("Upload failed"); }
        }

        function toggleRow(ip, port) {
            const safeIp = ip.replace(/\./g, '-');
            const rowId = 'detail-' + safeIp + '-' + port;
            const iconId = 'icon-' + safeIp + '-' + port;

            const row = document.getElementById(rowId);
            const icon = document.getElementById(iconId);

            if (row.style.display === 'none') {
                row.style.display = 'table-row';
                icon.style.transform = 'rotate(90deg)';
            } else {
                row.style.display = 'none';
                icon.style.transform = 'rotate(0deg)';
            }
        }

        // ==================== è‡ªå®šä¹‰ PHP è§„åˆ™ç®¡ç† ====================

        async function loadCustomRules() {
            try {
                const res = await fetch('/api/rules');
                const data = await res.json();
                const list = document.getElementById('custom-rules-list');
                if (!data.rules || data.rules.length === 0) {
                    list.innerHTML = '<div style="color: #999;">æš‚æ— è‡ªå®šä¹‰è§„åˆ™ã€‚å†…ç½®è§„åˆ™å·²åŒ…å«å¸¸è§ PHP å±é™©å‡½æ•°ã€‚</div>';
                    return;
                }
                list.innerHTML = data.rules.map((r, i) => `
                    <div style="display:flex; justify-content:space-between; align-items:center; padding:4px 0; border-bottom:1px solid var(--border-color);">
                        <span style="${r.enabled ? '' : 'opacity:0.5; text-decoration:line-through;'}">
                            <strong>${r.name}</strong> â€” <code>${r.pattern}</code>
                            ${r.description ? '<span style="color:#999;"> (' + r.description + ')</span>' : ''}
                        </span>
                        <span>
                            <button class="btn btn-sm" onclick="toggleCustomRule(${i})" style="font-size:10px;">${r.enabled ? 'â¸ï¸' : 'â–¶ï¸'}</button>
                            <button class="btn btn-sm" onclick="removeCustomRule(${i})" style="font-size:10px; color:#e74c3c;">ğŸ—‘ï¸</button>
                        </span>
                    </div>
                `).join('');
            } catch (e) { console.error('åŠ è½½è§„åˆ™å¤±è´¥', e); }
        }

        async function addCustomRule() {
            const name = document.getElementById('rule-name').value;
            const pattern = document.getElementById('rule-pattern').value;
            const desc = document.getElementById('rule-desc').value;
            if (!name || !pattern) return showToast('åç§°å’Œæ­£åˆ™è¡¨è¾¾å¼ä¸èƒ½ä¸ºç©º');
            const data = await apiCall('/api/rules/add', { name, pattern, description: desc });
            if (data) {
                showToast('è§„åˆ™å·²æ·»åŠ ');
                document.getElementById('rule-name').value = '';
                document.getElementById('rule-pattern').value = '';
                document.getElementById('rule-desc').value = '';
                loadCustomRules();
            }
        }

        async function removeCustomRule(index) {
            if (!confirm('åˆ é™¤æ­¤è§„åˆ™?')) return;
            const data = await apiCall('/api/rules/remove', { index });
            if (data) { showToast('è§„åˆ™å·²åˆ é™¤'); loadCustomRules(); }
        }

        async function toggleCustomRule(index) {
            const data = await apiCall('/api/rules/toggle', { index });
            if (data) { showToast(data.rule.enabled ? 'è§„åˆ™å·²å¯ç”¨' : 'è§„åˆ™å·²ç¦ç”¨'); loadCustomRules(); }
        }

        // ==================== è¿œç¨‹æ–‡ä»¶ç®¡ç†å™¨ (Refactored) ====================

        let fmIp = null, fmPort = null, fmCurrentPath = '/';

        function openFileManager(ip, port) {
            fmIp = ip;
            fmPort = port;
            fmCurrentPath = '/var/www/html';
            const key = 'fm-' + ip + ':' + port;

            document.getElementById('console-section').style.display = 'block';
            if (openTabs.has(key)) {
                activateTab(key);
                return;
            }
            openTabs.add(key);

            const header = document.getElementById('tabs-header');
            const btn = document.createElement('div');
            btn.className = 'tab-btn';
            btn.id = 'tab-btn-' + key.replace(/[:.]/g, '-');
            btn.innerHTML = `<span onclick="activateTab('${key}')">ğŸ“ ${ip}:${port}</span><span class="close-tab" onclick="closeFmTab(event, '${ip}', '${port}')">&times;</span>`;
            header.appendChild(btn);

            const container = document.getElementById('tabs-content-container');
            const content = document.createElement('div');
            content.className = 'tab-content';
            content.id = 'tab-content-' + key.replace(/[:.]/g, '-');

            // New Layout: Toolbar + Breadcrumbs + Table + Editor Modal (hidden by default)
            content.innerHTML = `
                <div class="flex-row" style="margin-bottom: 10px; background: var(--card-bg); padding: 5px; border-radius: 4px; border: 1px solid var(--border-color);">
                    <button class="btn btn-secondary btn-sm" onclick="fmGoUp('${ip}','${port}')">â¬†ï¸ Up</button>
                    <button class="btn btn-secondary btn-sm" onclick="fmReload('${ip}','${port}')">ğŸ”„ Refresh</button>
                    <input type="text" id="fm-path-${key.replace(/[:.]/g, '-')}" value="${fmCurrentPath}" style="flex-grow:1; margin: 0 10px;" onkeydown="if(event.key==='Enter') fmNavigate('${ip}','${port}')">
                    <button class="btn btn-primary btn-sm" onclick="fmNavigate('${ip}','${port}')">Go</button>
                    <span class="spacer"></span>
                    <button class="btn btn-primary btn-sm" onclick="document.getElementById('fm-upload-${key.replace(/[:.]/g, '-')}').click()">ğŸ“¤ Upload File</button>
                    <input type="file" id="fm-upload-${key.replace(/[:.]/g, '-')}" style="display:none;" onchange="fmUploadFile(this, '${ip}', '${port}')">
                </div>
                
                <div class="flex-row" style="margin-bottom: 10px; font-family: monospace; font-size: 14px;">
                    <strong>Path:</strong>
                    <div id="fm-breadcrumbs-${key.replace(/[:.]/g, '-')}" style="flex-grow: 1; margin-left: 10px;"></div>
                </div>

                <div style="flex-grow: 1; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 4px; background: var(--card-bg);">
                    <table id="fm-table-${key.replace(/[:.]/g, '-')}" style="font-size: 13px;">
                        <thead>
                            <tr style="background: rgba(0,0,0,0.02);">
                                <th style="width: 30px;">T</th>
                                <th>Name</th>
                                <th style="width: 80px;">Size</th>
                                <th style="width: 100px;">Perms</th>
                                <th style="width: 150px;">Date</th>
                                <th style="width: 120px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody><tr><td colspan="6" style="text-align:center;">Loading...</td></tr></tbody>
                    </table>
                </div>

                <!-- Simple Editor Modal -->
                <div id="fm-editor-modal-${key.replace(/[:.]/g, '-')}" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center;">
                    <div style="background:var(--card-bg); width:80%; height:80%; border-radius:8px; display:flex; flex-direction:column; padding:20px; box-shadow:0 4px 12px rgba(0,0,0,0.2);">
                        <div class="flex-row" style="margin-bottom:10px;">
                            <h3 style="margin:0;" id="fm-editor-title-${key.replace(/[:.]/g, '-')}">Edit</h3>
                            <span class="spacer"></span>
                            <button class="btn btn-primary" onclick="fmSaveFile('${ip}','${port}')">ğŸ’¾ Save</button>
                            <button class="btn btn-secondary" onclick="document.getElementById('fm-editor-modal-${key.replace(/[:.]/g, '-')}').style.display='none'">Close</button>
                        </div>
                        <textarea id="fm-editor-area-${key.replace(/[:.]/g, '-')}" style="flex-grow:1; font-family:'Consolas',monospace; resize:none; padding:10px; border:1px solid var(--border-color);"></textarea>
                    </div>
                </div>
            `;
            container.appendChild(content);
            activateTab(key);
            fmLoadDir(ip, port, fmCurrentPath);
        }

        function closeFmTab(e, ip, port) {
            e.stopPropagation();
            const key = 'fm-' + ip + ':' + port;
            const safeKey = key.replace(/[:.]/g, '-');
            openTabs.delete(key);
            document.getElementById('tab-btn-' + safeKey).remove();
            document.getElementById('tab-content-' + safeKey).remove();
            if (activeTabKey === key) {
                activeTabKey = null;
                if (openTabs.size > 0) activateTab(openTabs.values().next().value);
                else document.getElementById('console-section').style.display = 'none';
            }
        }

        async function fmLoadDir(ip, port, path) {
            const key = 'fm-' + ip + ':' + port;
            const safeKey = key.replace(/[:.]/g, '-');
            const tbody = document.querySelector(`#fm-table-${safeKey} tbody`);
            const breadcrumbs = document.getElementById('fm-breadcrumbs-' + safeKey);

            fmCurrentPath = path;

            // Update Breadcrumbs
            const parts = path.split('/').filter(p => p);
            let bcHtml = `<span onclick="fmLoadDir('${ip}','${port}','/')" style="cursor:pointer;color:var(--primary-color);">/</span>`;
            let currentP = '';
            parts.forEach((p, i) => {
                currentP += '/' + p;
                bcHtml += ` / <span onclick="fmLoadDir('${ip}','${port}','${currentP}')" style="cursor:pointer;color:var(--primary-color);">${p}</span>`;
            });
            breadcrumbs.innerHTML = bcHtml;

            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Loading...</td></tr>';

            const data = await apiCall('/api/files/list', { ip, port: parseInt(port), path });
            if (data && data.error) {
                tbody.innerHTML = `<tr><td colspan="6" style="color:var(--danger-color);text-align:center;">${data.error}</td></tr>`;
                return;
            }
            if (!data || !data.files) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#999;">Empty directory</td></tr>';
                return;
            }

            let html = '';
            // Sort: Dir first, then name
            const sorted = data.files.sort((a, b) => (b.is_dir - a.is_dir) || a.name.localeCompare(b.name));

            for (const f of sorted) {
                const icon = f.is_dir ? 'ğŸ“‚' : (f.is_link ? 'ğŸ”—' : 'ğŸ“„');
                const fullPath = path.replace(/\/$/, '') + '/' + f.name;
                const size = f.is_dir ? '-' : (f.size < 1024 ? f.size + ' B' : (f.size / 1024).toFixed(1) + ' KB');
                const date = new Date(f.mtime * 1000).toLocaleString();

                let actions = '';
                if (!f.is_dir) {
                    actions += `<button class="btn btn-sm btn-primary" onclick="fmOpenFile('${ip}','${port}','${fullPath}')" title="Edit">âœï¸</button> `;
                    actions += `<button class="btn btn-sm btn-success" onclick="fmDownloadFile('${ip}','${port}','${fullPath}')" title="Download">â¬‡ï¸</button> `;
                } else {
                    actions += `<button class="btn btn-sm btn-secondary" onclick="fmLoadDir('${ip}','${port}','${fullPath}')" title="Open">ğŸ“‚</button> `;
                }
                actions += `<button class="btn btn-sm btn-danger" onclick="fmDeleteFile('${ip}','${port}','${fullPath}')" title="Delete">ğŸ—‘ï¸</button>`;

                const rowClick = f.is_dir ? `fmLoadDir('${ip}','${port}','${fullPath}')` : '';
                const rowStyle = f.is_dir ? 'cursor:pointer; font-weight:500;' : '';

                html += `
                    <tr>
                        <td onclick="${rowClick}" style="${rowStyle}">${icon}</td>
                        <td onclick="${rowClick}" style="${rowStyle}">${f.name}</td>
                        <td>${size}</td>
                        <td style="font-family:monospace;font-size:12px;">${f.perms || '-'}</td>
                        <td style="font-size:12px;color:#666;">${date}</td>
                        <td>${actions}</td>
                    </tr>
                `;
            }
            tbody.innerHTML = html;
        }

        function fmNavigate(ip, port) {
            const key = 'fm-' + ip + ':' + port;
            const safeKey = key.replace(/[:.]/g, '-');
            const path = document.getElementById('fm-path-' + safeKey).value;
            fmLoadDir(ip, port, path);
        }

        function fmGoUp(ip, port) {
            const parent = fmCurrentPath.split('/').slice(0, -1).join('/') || '/';
            fmLoadDir(ip, port, parent);
        }

        function fmReload(ip, port) {
            fmLoadDir(ip, port, fmCurrentPath);
        }

        let currentEditPath = '';
        // Helper to jump to file manager and edit file
        function quickEditFile(ip, port, path) {
            openFileManager(ip, port);
            fmOpenFile(ip, port, path);
        }

        async function fmOpenFile(ip, port, path) {
            const key = 'fm-' + ip + ':' + port;
            const safeKey = key.replace(/[:.]/g, '-');
            currentEditPath = path;

            document.getElementById(`fm-editor-modal-${safeKey}`).style.display = 'flex';
            document.getElementById(`fm-editor-title-${safeKey}`).innerText = 'Editing: ' + path;
            const textarea = document.getElementById(`fm-editor-area-${safeKey}`);
            textarea.value = 'Loading...';

            const data = await apiCall('/api/files/read', { ip, port: parseInt(port), path });
            if (data && data.content !== undefined) {
                textarea.value = data.content;
            } else {
                textarea.value = 'Error reading file: ' + (data ? data.error : 'Unknown');
            }
        }

        async function fmSaveFile(ip, port) {
            const key = 'fm-' + ip + ':' + port;
            const safeKey = key.replace(/[:.]/g, '-');
            const content = document.getElementById(`fm-editor-area-${safeKey}`).value;

            showToast("Saving...");
            const data = await apiCall('/api/files/write', { ip, port: parseInt(port), path: currentEditPath, content });
            if (data && data.success) {
                showToast("Saved successfully");
                document.getElementById(`fm-editor-modal-${safeKey}`).style.display = 'none';
                fmReload(ip, port);
            } else {
                showToast("Error: " + (data ? data.message : 'Unknown'));
            }
        }

        async function fmDeleteFile(ip, port, path) {
            if (!confirm(`Delete ${path}?`)) return;
            const data = await apiCall('/api/files/delete', { ip, port: parseInt(port), path });
            if (data && data.success) {
                showToast("Deleted");
                fmReload(ip, port);
            } else {
                showToast("Error: " + (data ? data.message : 'Unknown'));
            }
        }

        function fmDownloadFile(ip, port, path) {
            window.location.href = `/api/files/download?ip=${ip}&port=${port}&path=${encodeURIComponent(path)}`;
        }

        async function fmUploadFile(input, ip, port) {
            if (input.files.length === 0) return;
            const file = input.files[0];
            const formData = new FormData();
            formData.append('file', file);
            formData.append('ip', ip);
            formData.append('port', port);
            formData.append('path', fmCurrentPath);

            showToast("Uploading " + file.name + "...");
            try {
                const res = await fetch('/api/files/upload', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                if (data.success) {
                    showToast("Upload success");
                    fmReload(ip, port);
                } else {
                    showToast("Upload failed: " + data.error);
                }
            } catch (e) {
                showToast("Upload error: " + e);
            }
            input.value = ''; // clear
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–è§„åˆ™åˆ—è¡¨
        document.addEventListener('DOMContentLoaded', () => {
            loadCustomRules();
        });
    </script>
</body>

</html>